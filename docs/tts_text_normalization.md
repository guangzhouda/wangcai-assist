# TTS 文本归一化（解决中文播报里的“数字/乱码/奇怪符号”）

在语音助手链路里，LLM 的输出经常包含：

- 阿拉伯数字：`2026-02-04`、`50%`、`3.14`
- Markdown/格式：`**加粗**`、`- 列表`、代码块
- 表情/生僻符号：emoji、特殊括号、奇怪的分隔符

而很多中文 TTS（尤其是 **MeloTTS / 某些 Piper 音色**）对这些内容不友好，常见表现：

- 数字读不出来、读错、或卡一下
- 句子中间“突然冒出”一些乱七八糟的音（通常来自不可读符号/格式）
- 播报听起来像“人机”、断裂明显

本项目提供了两层解决方案：**提示词约束 + 本地文本归一化**。

---

## 1) DeepSeek 提示词（System Prompt）已做 TTS 友好化

在 `voice_chat.py` 里，system prompt 已更新为：

- 尽量不用 Markdown/代码块/链接/表情
- 尽量用中文数字表达，避免阿拉伯数字
- 分点用“第一、第二…”
- 不确定先澄清，不编造

这样可以从源头减少 “TTS 不可读内容”。

---

## 2) 本地文本归一化（`text_normalize.py`）

当 `TTS_TEXT_NORMALIZE=1`（默认开启）时，**送入 TTS 的文本**会做处理：

### 2.1 去 Markdown

- 去掉代码块标记 ``` 和反引号 `
- 去掉强调符号 `**` `*` `__`
- 把常见 bullet（`- `、`•`）替换成更口语的停顿

### 2.2 阿拉伯数字 → 中文可播报数字

规则（启发式，足够应对大多数播报场景）：

- 长数字（>=7 位）或前导零：按“逐位读”（适合手机号/验证码）
  - `13800138000` → `一三八零零一三八零零零`
  - `001` → `零零一`
- 4 位年份（1000~2099）：按“逐位读”
  - `2026` → `二零二六`
- 小数：
  - `3.14` → `三点一四`
- 百分号：
  - `50%` → `百分之五十`
- 其他整数：使用 `cn2an.an2cn()`（例如 123 → 一百二十三）

### 2.3 可选：剔除 emoji/罕见符号

- `TTS_STRIP_NON_TEXT=1`（默认开启）会过滤掉非中文/非常见标点的字符，避免出现“奇怪音”。

---

## 3) 如何开关

在 PowerShell 里：

```powershell
# 默认开启（推荐）
$env:TTS_TEXT_NORMALIZE = "1"
$env:TTS_STRIP_NON_TEXT = "1"

# 如果你想完全保留原样（不建议）
$env:TTS_TEXT_NORMALIZE = "0"
```

说明：

- 对 `TTS_ENGINE=matcha`（英文 TTS）会自动跳过中文数字归一化，避免把英文句子搞乱。

---

## 4) 仍然“中间出现怪东西”怎么办？

1) 先把 LLM 输出变得更“可播报”：
   - 让它回答更短
   - 禁用 Markdown
   - 避免网址、代码、表情

2) 如果是控制台里混入了 warning/log：
   - 可以设置 `VOICE_DEBUG=0`（默认就是）保持安静
   - 某些库会 `print()`（不走 logging），这类输出需要针对性处理（例如把 print 改掉或重定向）

3) 如果是 ASR 误识别导致内容离谱：
   - 先看 `最终:` 的识别文本是否正确
   - 需要的话提高麦克风质量、或调整 VAD 阈值/静音时长

